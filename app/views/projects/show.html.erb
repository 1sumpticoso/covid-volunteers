<%- share_title "Project #{@project.name}" %>
<%- share_url project_url(@project); %>

<div class="container">
  <% if current_user && (current_user == @project.user || current_user.is_admin?) %>
    <div class="mx-4 sm:mx-0 bg-white px-4 py-5 border-b border-gray-200 sm:px-6 mb-8 rounded-lg shadow">
      <div class="-ml-4 -mt-4 flex justify-between items-center flex-wrap">
        <div class="ml-4 mt-4">
          <h3 class="text-lg leading-6 font-medium text-gray-900">
            <%= @project.name %>
          </h3>

          <% if current_user && @project.user == current_user %>
            <p class="mt-1 text-sm leading-5 text-gray-500">
              Use <%= link_to "HWC's Discord", "https://discord.gg/8nAJfFN", class: "text-primary-500", target: "_blank" %> to manage your project communication.
            </p>
          <% elsif @project.user && @project.user.name.present? %>
            <div class="mt-1">
              <% if @project.user.visibility %>
                <%= link_to profile_path(@project.user), class: 'flex-shrink-0 group inline-block focus:outline-none' do %>
                  <%= render partial: 'user_avatar', locals: {user: @project.user} %>
                <% end %>
              <% else %>
                <%= render partial: 'user_avatar', locals: {user: @project.user} %>
              <% end %>
            </div>
          <% end %>
        </div>

        <div class="flex flex-shrink-0 flex-wrap max-w-full">
          <span class="ml-3 inline-flex rounded-md shadow-sm mt-4">
            <%= link_to edit_project_path(@project) do %>
              <button type="button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm leading-5 font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:shadow-outline-blue focus:border-blue-300 active:bg-gray-50 active:text-gray-800">
                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                </svg>
                <span>
                  Edit
                </span>
              </button>
            <% end %>
          </span>

          <% if @project.volunteered_users.count > 0 %>
            <% volunteer_emails = @project.volunteer_emails %>

            <span class="ml-3 inline-flex rounded-md shadow-sm mt-4">
              <%= mail_to current_user.email, bcc: volunteer_emails.join(', ') do %>
                <button type="button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm leading-5 font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:shadow-outline-blue focus:border-blue-300 active:bg-gray-50 active:text-gray-800">
                  <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                  </svg>
                  <span>
                    Send email to volunteers
                  </span>
                </button>
              <% end %>
            </span>

            <span class="ml-3 inline-flex rounded-md shadow-sm mt-4">
              <%= link_to volunteers_project_path(@project, format: 'csv') do %>
                <button type="button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm leading-5 font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:shadow-outline-blue focus:border-blue-300 active:bg-gray-50 active:text-gray-800">
                  <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span>
                    Export volunteers to CSV
                  </span>
                </button>
              <% end %>
            </span>
          <% end %>

          <% if @project.can_edit?(current_user) %>
            <%= link_to project_path(project_id: @project.id), method: :delete, data: { confirm: "Are you sure you want to delete this project?" } do %>
              <span class="ml-3 inline-flex rounded-md shadow-sm mt-4">
                <button type="button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm leading-5 font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:text-gray-800 active:bg-gray-50 transition ease-in-out duration-150">
                  <svg class="-ml-1 mr-2 h-5 w-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span>
                    Delete
                  </span>
                </button>
              </span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% if current_user && current_user.is_admin? %>
    <div class="bg-white mt-6 border-2 border-red-300 bg-red-100 shadow sm:rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Admin area
        </h3>
        <div class="flex justify-left mt-3 text-sm leading-5">
          <%= link_to toggle_project_highlight_path(project_id: @project.id), method: :post do %>
            <span class="inline-flex rounded-md shadow-sm mt-4">
              <button type="button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm leading-5 font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:text-gray-800 active:bg-gray-50 transition ease-in-out duration-150">
                <span>
                  <% if @project.highlight %>
                    Remove highlight
                  <% else %>
                    Highlight
                  <% end %>
                </span>
              </button>
            </span>
          <% end %>

          <%= link_to new_volunteer_group_path(project_id: @project.id), target: "_blank" do %>
            <span class="ml-6 inline-flex rounded-md shadow-sm mt-4">
              <button type="button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm leading-5 font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:text-gray-800 active:bg-gray-50 transition ease-in-out duration-150">
                <span>
                  Assign volunteers
                </span>
              </button>
            </span>
          <% end %>

          <%= link_to edit_project_path(project_id: @project.id) do %>
            <span class="ml-6 inline-flex rounded-md shadow-sm mt-4">
              <button type="button" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm leading-5 font-medium rounded-md text-gray-700 bg-white hover:text-gray-500 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:text-gray-800 active:bg-gray-50 transition ease-in-out duration-150">
                <span>
                  Edit project
                </span>
              </button>
            </span>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% if current_user && @project.volunteered_users.count < MAX_VOLUNTEERS_FOR_HIGHLIGHT_OFFER && @project.user == current_user && !cookies[:highlight_projects_alert] %>
    <div class="bg-white mt-6 mb-8 border-2 border-orange-300 bg-orange-100 shadow sm:rounded-lg" id="disable_highlight_projects_container">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Are you a validated or established project with large impact?
        </h3>
        <div class="mt-2 text-sm leading-5 text-gray-500">
          <p>
            We try our best to surface interesting projects with lots of potential that just need a bit of a boost. Write to us if that's the case.
          </p>
        </div>
        <div class="flex justify-between mt-3 text-sm leading-5">
          <%= mail_to ENV['EMAIL_ADDRESS'], "Tell us about your project &rarr;".html_safe, subject: "[Highlight request] #{@project.name} ", encoding: "hex", target: "_blank", class: "font-medium text-primary-600 hover:text-primary-500 focus:outline-none focus:underline transition ease-in-out duration-150" %>
          <%= link_to "javascript:void(0)", id: "disable_highlight_projects_alert", class: "font-medium text-primary-600 hover:text-primary-500 focus:outline-none focus:underline transition ease-in-out duration-150" do %>
            Don't show this again
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% if current_user && @project.volunteered_users.count >= VOLUNTEERS_REQUIRED_FOR_FUNDING && @project.user == current_user && !cookies[:funding_alert] %>
    <div class="bg-white mt-6 border-2 border-orange-300 bg-orange-100 shadow sm:rounded-lg mb-8" id="disable_funding_container">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Apply for funding
        </h3>
        <div class="mt-2 text-sm leading-5 text-gray-500">
          <p>
            The <%= link_to "COVID-19 Task Force", "www.covid19-response.com", _target: "_blank", class: "text-primary-500" %> offers HWC projects that reach a certain threshold of volunteers the ability to apply for funding and resources from donors and investors. The TF is made up of epidemiologists, virologist, operators, and investors that are vetting the highest impact ideas to combat COVID-19.
          </p>
        </div>
        <div class="flex justify-between mt-3 text-sm leading-5">
          <%= link_to "https://forms.gle/5gLZBUueYxZYynrP8", target: "_blank", class: "font-medium text-primary-600 hover:text-primary-500 focus:outline-none focus:underline transition ease-in-out duration-150" do %>
            Submit an application here &rarr;
          <% end %>
          <%= link_to "javascript:void(0)", id: "disable_funding_alert", class: "font-medium text-primary-600 hover:text-primary-500 focus:outline-none focus:underline transition ease-in-out duration-150" do %>
            Don't show this again
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <div>
    <div class="overflow-hidden sticky top-10 z-40 mb-8 sm:hidden">
      <%= render partial: 'volunteer_button' %>
    </div>
    <div class="mt-0 mx-4 gap-0 rounded-lg bg-white shadow overflow-hidden sm:mx-0 sm:grid sm:grid-cols-2">
      <div class="sm:col-span-1 relative h-40 sm:h-auto bg-cover bg-center" style="background-image: url(<%= @project.image.present? ? @project.cover_photo : '/images/project-default.png' %>);">
        <% if @project.status.present? %>
          <div class="absolute top-4 left-4 rounded-full overflow-hidden">
            <% if @project.status == "Just started" %>
              <div class="bg-orange-500 flex items-center px-3 py-1 opacity-75">
                <%= inline_svg_pack_tag 'media/svgs/glowing-lightbulb.svg', class: 'mr-1 text-white fill-current' %>
                <span class="text-white text-sm font-bold">Idea Stage</span>
              </div>
            <% elsif @project.status == "In progress" %>
              <div class="bg-green-500 flex items-center px-3 py-1 opacity-75">
                <%= inline_svg_pack_tag 'media/svgs/half-dotted-circle.svg', class: 'mr-1 text-white fill-current' %>
                <span class="text-white text-sm font-bold">In Progress</span>
              </div>
            <% elsif @project.status == "Launched" %>
              <div class="bg-teal-500 flex items-center px-3 py-1 opacity-75">
                <%= inline_svg_pack_tag 'media/svgs/sparkling-stars.svg', class: 'mr-1 text-white fill-current' %>
                <span class="text-white text-sm font-bold">Launched</span>
              </div>
            <% end %>
          </div>
        <% end %>
        <% if @project.accepting_volunteers? %>
          <div class="absolute top-4 right-4 rounded-full overflow-hidden">
            <div class="flex items-center px-3 py-1" style="background-color: rgba(0, 0, 0, 0.5)">
              <%= inline_svg_pack_tag 'media/svgs/lightning.svg', class: 'mr-1 text-white fill-current' %>
              <span class="text-white text-sm font-bold">Actively Recruiting</span>
            </div>
          </div>
        <% end %>
      </div>
      <div class="sm:col-span-1 flex-col justify-between">
        <div class="p-4 sm:p-6 pb-7">
          <h1 class="text-xl leading-tight text-primary-600 font-bold">
            <%= @project.name %>
          </h1>
          <% if @project.description? %>
            <%= simple_format Rinku.auto_link(sanitize(@project.short_description), :all, 'class="text-primary-500" rel="nofollow noopener noreferrer"'), { class: 'mb-5 mt-3 text-sm' }, sanitize: false %>
          <% end %>
          <% if @project.project_type_list.present? %>
            <div class="mt-5 text-sm leading-5 text-gray-900 flex content-center flex-wrap space-y-bottom-2 space-x-right-2">
              <%= skill_badges @project.project_type_list, model: 'projects', filter_by: 'project_types' %>
            </div>
          <% end %>
          <div class="mt-4 flex flex-col lg:flex-row lg:justify-between">
            <div class="flex items-center text-primary-600 col-span-1">
              <%= inline_svg_pack_tag 'media/svgs/location-pin.svg', class: 'h-6 mr-2 text-primary-600 fill-current' %>
              <span class="text-gray-500 text-xs font-bold leading-tight">
                <%= (@project.target_country.blank? || @project.target_country == "Global") ? "Global" : "Serves in #{format_country(@project.target_country)}" %>
              </span>
            </div>
            <div class="flex items-center text-primary-600 col-span-1">
              <%= inline_svg_pack_tag 'media/svgs/time-ago.svg', class: 'h-6 mr-2 text-primary-600 fill-current' %>
              <span class="text-gray-500 text-xs font-bold leading-tight">Created <%= time_ago_in_words(@project.created_at) %> ago</span>
            </div>
            <div class="flex items-center text-primary-600 col-span-1">
              <%= inline_svg_pack_tag 'media/svgs/people.svg', class: 'h-6 mr-2 text-primary-600 fill-current' %>
              <span class="text-gray-500 text-xs font-bold leading-tight"><%= @project.volunteers.count %> <%= 'Volunteer'.pluralize @project.volunteers.count %></span>
            </div>
          </div>
        </div>
        <% parsed_url_from_demo = url_from_string(@project.docs_and_demo) %>
        <% if (@project.docs_and_demo.present? && parsed_url_from_demo) or true %>
          <div class="p-6 pt-3 pb-3 bg-primary-600 text-white">
            <a href="<%= parsed_url_from_demo %>" rel="nofollow noopener noreferrer" target="_blank" class="flex justify-center items-center text-sm font-medium">
              <span><%= shorten_url parsed_url_from_demo %></span>
              <%= inline_svg_pack_tag 'media/svgs/external-link.svg', class: 'ml-2 text-white fill-current' %>
            </a>
          </div>
        <% end %>
      </div>
    </div>

    <div class="mt-8 mx-4 sm:grid sm:grid-cols-3 sm:gap-10 sm:mx-0">
      <div class="sm:col-span-2">
        <div class="bg-white overflow-hidden rounded-lg sm:pb-4 shadow">
          <div class="p-4 sm:px-6 sm:py-3 bg-secondary-100 border-b border-primary-400">
            <h3 class="text-primary-700 font-bold">About the Project</h3>
          </div>

          <div class="p-4 sm:px-6 sm:pt-5 sm:pb-2">
            <dt class="text-sm leading-5 font-bold text-gray-800">
              Description
            </dt>
            <dd class="mt-2 text-sm leading-5 text-gray-600">
              <%= simple_format Rinku.auto_link(sanitize(@project.description), :all, 'class="text-primary-500" rel="nofollow noopener noreferrer"'), { class: 'mb-3' }, sanitize: false %>
            </dd>
          </div>

          <% if @project.progress.present? %>
            <div class="p-4 sm:px-6 sm:pt-4 sm:pb-2">
              <dt class="text-sm leading-5 font-bold text-gray-800">
                How far along is it
              </dt>
              <dd class="mt-2 text-sm leading-5 text-gray-600">
                <%= simple_format Rinku.auto_link(sanitize(@project.progress), :all, 'class="text-primary-500" rel="nofollow noopener noreferrer"'), { class: 'mb-3' }, sanitize: false %>
              </dd>
            </div>
          <% end %>

          <% if @project.target_location.present? %>
            <div class="p-4 sm:px-6 sm:pt-4 sm:pb-2">
              <dt class="text-sm leading-5 font-bold text-gray-800">
                Project target location
              </dt>
              <dd class="mt-2 text-sm leading-5 text-gray-600">
                <%= @project.target_location %>
              </dd>
            </div>
          <% end %>
        </div>

        <div class="mt-8 bg-white overflow-hidden rounded-lg shadow">
          <div class="p-4 sm:px-6 sm:py-3 bg-secondary-100 border-b border-primary-400">
            <h3 class="text-primary-700 font-bold">Help Needed</h3>
          </div>

          <% if @project.skill_list.present? %>
            <div class="p-4 sm:px-6 sm:pt-5 sm:pb-2">
              <dt class="text-sm leading-5 font-medium text-gray-800">
                Skills needed
              </dt>
              <dd class="mt-2 text-sm leading-5 text-gray-600 flex content-center flex-wrap space-y-bottom-2 space-x-right-2">
                <%= skill_badges @project.skill_list, color: 'blue', model: 'projects', filter_by: 'skills' %>
              </dd>
            </div>
          <% end %>

          <% if @project.accepting_volunteers? %>
            <div class="p-4 sm:px-6 sm:pt-4 sm:pb-2">
              <dt class="text-sm leading-5 font-bold text-gray-800">
                Tasks that need to get done
              </dt>
              <dd class="mt-2 text-sm leading-5 text-gray-600">
                <%= simple_format @project.looking_for, class: 'mb-3' %>
              </dd>
            </div>
          <% end %>
        </div>
      </div>

      <div class="mt-8 sm:col-span-1 sm:mt-0">
        <div class="sm:sticky sm:top-10">
          <div class="overflow-hidden mb-8 hidden sm:block">
            <%= render partial: 'volunteer_button' %>
          </div>

          <div class="bg-white overflow-hidden rounded-lg sm:sticky sm:top-0 shadow">
            <div class="p-4 sm:px-6 sm:py-3 bg-secondary-100 border-b border-primary-400">
              <h3 class="text-primary-700 font-bold">Project details</h3>
            </div>

            <div class="p-6 space-y-4">
              <%= project_panel_item(title: 'Who is already working on this') do %>
                <%= simple_format Rinku.auto_link(sanitize(@project.participants), :all, 'class="text-primary-500" rel="nofollow noopener noreferrer"'), { class: 'mb-3' }, sanitize: false %>
              <% end %>

              <% if @project.links.present? %>
                <%= project_panel_item(title: 'Helpful links') do %>
                  <div>
                    <%= simple_format (Rinku.auto_link(sanitize(@project.links), :all, 'class="text-primary-500" rel="nofollow noopener noreferrer"') do |url|
                      url.length > 35 ? shorten_url(url_from_string(url.start_with?('http') ? url : "http://#{url}")) : url
                    end), { class: 'mb-1' }, sanitize: false %>
                  </div>
                <% end %>
              <% end %>

              <% if @project.contact.present? %>
                <%= project_panel_item(title: 'How to get in touch') do %>
                  <%= Rinku.auto_link(sanitize(@project.contact), :all, 'class="text-primary-500" rel="nofollow noopener noreferrer"').html_safe %>
                <% end %>
              <% end %>

              <% if @project.accepting_volunteers? %>
                <% if @project.number_of_volunteers.present? %>
                  <%= project_panel_item(title: 'Number of volunteers needed') do %>
                    <%= @project.number_of_volunteers %>
                  <% end %>
                <% end %>

                <% if @project.volunteer_location.present? %>
                  <%= project_panel_item(title: 'Preferred Volunteer location') do %>
                    <%= @project.volunteer_location %>
                  <% end %>
                <% end %>

                <%= project_panel_item(title: 'Organization status') do %>
                  <% if @project.organization_status.present? %>
                    <div class="flex items-end">
                      <%= @project.organization_status %>

                      <% if @project.organization_status == "Non-profit" && @project.ein.present? %>
                        <span class="ml-1">
                          (EIN: <%= @project.ein %>)
                        </span>
                      <% end %>
                    </div>
                  <% else %>
                    <div class="flex items-end">
                      Not specified
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if current_user && @project.volunteered_users.count > 0 && (current_user == @project.user || current_user.is_admin?) %>
    <div class="mt-8 bg-white overflow-hidden sm:rounded-lg sm:shadow">
      <div class="bg-white px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">
          Volunteers
        </h3>
      </div>

        <ul>
          <% @project.volunteers.includes(user: :skills).each do |volunteer| %>
            <% user = volunteer.user %>
            <%= render partial: 'devise/registrations/user', locals: { user: user, volunteer: volunteer } %>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>
</div>
